<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@1,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="style.css">
    <!-- Styles moved to style.css for maintainability -->
    <title>Document</title>
</head>
<body>
    <!--Navigation Bar-->
    <nav>
        <div class="logo">
            <a href="index.html">
            <img src="logoo.png" alt="lakbay-logo">
            </a>
            <a href="index.html">
                <span class="logo-text">Routify</span>
            </a>
        </div>
        <div class="controls">
            <!--Search Bar-->
            <div class="search-container">
                <i class="bi bi-search search-icon"></i>
                <input list="routes" class="search-bar" placeholder="Select your route">
                <datalist id="routes">
                    <option value="Angat - Monumento">
                    <option value="Norzagaray - Divisoria">
                    <option value="Sapangpalang - Manila">
                    <option value="Santa Maria - Meycauayan">
                </datalist>
            </div>
            <!--Buttons for commuters, drivers, and profile-->
            <ul>
                <li><a href="commuter.html">
                    <i class="bi bi-person-circle"></i> 
                    <span>Commuter</span>
                </a></li>
                <li><a href="driver.html" class="active">
                    <i class="bi bi-car-front-fill"></i> Driver
                </a></li>
                <li class="main-menu"><a href="#">
                    <i class="bi bi-list"></i>
                    <span class="menu-text">Menu</span>
                </a></li>
            </ul>
        </div>
    </nav>

    <!--Div for the leaflet map to set as the website background image-->
    <div class="leaflet-map" id="map"></div>

    <!--Part of the website that shows most of the information-->

    <!-- Backdrop shown when the drivers panel is open. Clicking it will close the panel. -->
    <div id="panel-backdrop"></div>

    <div class="drivers-info" id="drivers-info">
        <button class="panel-close-small" id="drivers-info-close" aria-label="Close">×</button>
    <!-- select-route pill removed -->

        <div class="driverstatus-info">

            <div class="route-select" aria-label="Route selection">
                <!-- Left icon column and stacked route inputs (matches provided screenshot) -->
                <div class="route-input">
                    <div class="route-icons" aria-hidden="true">
                        <i class="bi bi-record-circle start-icon" title="Start"></i>
                        <i class="bi bi-geo-alt-fill dest-icon" title="Destination"></i>
                    </div>

                    <div class="route-fields">
                        <div class="route-field start-field" tabindex="0" data-type="start">
                            <input readonly class="route-text start-input" aria-label="Starting point">
                        </div>

                        <div class="route-field dest-field" tabindex="0" data-type="dest">
                            <input readonly class="route-text dest-input" aria-label="Destination">
                        </div>
                    </div>
                </div>

                <div class="route-picker" aria-hidden="true" style="display:none">
                    <ul class="route-options">
                        <li class="route-option">Angat</li>
                        <li class="route-option">Monumento</li>
                        <li class="route-option">Sta Maria</li>
                        <li class="route-option">Pulong Buhangin</li>
                        <li class="route-option">Norzagaray</li>
                    </ul>
                </div>
            </div>

            <!-- status removed per request -->

        
            <div class="recent-routes">
                <h4>Recent routes</h4>
                <ul class="recent-list">
                    <li class="recent-item">Angat - Monumento</li>
                    <li class="recent-item">Sta Maria - Pulong Buhangin</li>
                    <li class="recent-item active">Norzagaray - Divisoria</li>
                </ul>
            </div>
        </div>

        <div class="driver-buttons">
            <button id="trip-toggle" class="start-trip-button">Start Trip</button>
        </div>
        
        </div>
    </div>

    <!-- Bottom-center handle button to toggle the drivers-info panel -->
    <button id="panel-handle-button" aria-label="Open panel" title="Open panel"></button>

    <!--Script for the leaflet map-->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="">
    </script>
    <!-- Leaflet Routing Machine JS (required for L.Routing.control) -->
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
    <script>
        // Initialize Leaflet map
        const map = L.map('map').setView([14.831426, 120.976661], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        // Wire drivers-info close control and the bottom-center handle behavior
        (function(){
            function update(state){
                var btn = document.getElementById('panel-handle-button');
                var backdropEl = document.getElementById('panel-backdrop');
                var panelEl = document.getElementById('drivers-info');
                if(!btn) return;
                if(state){
                    // opening: remove forced inline hiding so CSS animation can run
                    if(panelEl){
                        panelEl.style.removeProperty('transform');
                        panelEl.style.removeProperty('visibility');
                        panelEl.style.removeProperty('pointer-events');
                        panelEl.classList.add('open');
                    }
                    btn.classList.add('open'); btn.setAttribute('title','Close panel');
                    if(backdropEl) backdropEl.classList.add('visible');
                } else {
                    // closing: force-hidden via inline !important to avoid any overrides from other stylesheets
                    if(panelEl){
                        panelEl.classList.remove('open');
                        panelEl.style.setProperty('transform', 'translate(-50%, 110%)', 'important');
                        panelEl.style.setProperty('visibility', 'hidden', 'important');
                        panelEl.style.setProperty('pointer-events', 'none', 'important');
                    }
                    btn.classList.remove('open'); btn.setAttribute('title','Open panel');
                    if(backdropEl) backdropEl.classList.remove('visible');
                }
            }
            // expose so marker handlers can call it
            window.updatePanelHandle = update;
            // start closed — ensure panel and backdrop are definitely hidden on load
            update(false);

            var backdrop = document.getElementById('panel-backdrop');
            var closeBtn = document.getElementById('drivers-info-close');
            if(closeBtn){ closeBtn.addEventListener('click', function(){
                var panel = document.getElementById('drivers-info'); if(panel) panel.classList.remove('open');
                // hide backdrop and update handle
                update(false);
            }); }

            // Clicking the backdrop should close the panel as well
            if(backdrop){ backdrop.addEventListener('click', function(){
                var panel = document.getElementById('drivers-info'); if(panel) panel.classList.remove('open');
                update(false);
            }); }

            var handleBtn = document.getElementById('panel-handle-button');
            if(handleBtn){
                handleBtn.addEventListener('click', function(){
                    var panel = document.getElementById('drivers-info'); if(!panel) return;
                    var opening = !panel.classList.contains('open');
                    if(opening) panel.classList.add('open'); else panel.classList.remove('open');
                    update(opening);
                });
            }
        })();
        map.zoomControl.setPosition('bottomleft');

        // Passenger icon
        var PassengerIcon = L.icon({
            iconUrl: 'https://image2url.com/images/1762271241467-09178dbf-94d7-4a82-88f4-4ee7626f1570.png',
            iconSize: [50, 50],
            iconAnchor: [25, 40],
            popupAnchor: [0, -46]
        });

    var commuterMarker = L.marker([14.831341439952697, 120.97348565571966], { icon: PassengerIcon, title: 'Passenger' }).addTo(map);


        // Simple custom icon for the jeepney marker (falls back to default if file missing)
                var jeepneyIcon = L.icon({
                    iconUrl: 'https://image2url.com/images/1761748252176-39f2cd27-02a7-4b73-b140-6171e24e62be.png',
                    iconSize: [36, 36],
                    iconAnchor: [18, 36],
                    // lift the popup a bit higher so it doesn't overlap the icon
                    popupAnchor: [0, -46]
                });

                // Route Sta Maria - Guyong - Caypombo - Pulong Buhangin
            var waypoints = [
                L.latLng(14.821865560449373, 120.96157688030809), // Sta Maria - Starting point
                L.latLng(14.831341439952697, 120.97348565571966), // Dulong
                L.latLng(14.87136358444958, 121.00656357695095)  // Pulong Buhangin - Endpoint
            ];
        // Create the routing control (this replaces your polyline)
        var routingControl = L.Routing.control({
            waypoints: waypoints,
            routeWhileDragging: false,  // Disable dragging to keep it static
            addWaypoints: false,        // Prevent users from adding/removing waypoints
                createMarker: function(i, waypoint, n) {
                // Custom marker only at the start (index 0)
        if (i === 0) {
            var marker = L.marker(waypoint.latLng, { icon: jeepneyIcon });
            return marker;
        }
                return null;  // No markers for intermediate waypoints
            },
            lineOptions: {
                styles: [{ color: 'green', weight: 4 }]  /* Lines of route */
            },
            router: L.Routing.osrmv1({  
            })
        }).addTo(map);

        // --- Driver UI interactions: start/destination selection, recent routes, and trip toggle ---
        (function(){
            var startInput = document.querySelector('.start-input');
            var destInput = document.querySelector('.dest-input');
            var routePicker = document.querySelector('.route-picker');
            var routeOptions = document.querySelectorAll('.route-option');
            var recentList = document.querySelector('.recent-list');
            var tripToggle = document.getElementById('trip-toggle');
            var currentRouteEl = document.querySelector('.current-route');

            function updateTripToggleState(){
                if(!tripToggle) return;
                var ok = startInput && startInput.value.trim() && destInput && destInput.value.trim();
                tripToggle.disabled = !ok;
                if(!ok){ tripToggle.classList.add('disabled'); } else { tripToggle.classList.remove('disabled'); }
            }

            function setCurrentRouteCombined(){
                var s = startInput ? startInput.value.trim() : '';
                var d = destInput ? destInput.value.trim() : '';
                var combined = (s && d) ? (s + ' - ' + d) : '—';
                if(currentRouteEl) currentRouteEl.textContent = combined;
                return combined;
            }

            function pushRecentRoute(name){
                if(!recentList) return;
                // remove existing matching
                Array.from(recentList.children).forEach(function(li){ if(li.textContent.trim()===name) li.remove(); });
                var li = document.createElement('li'); li.className='recent-item active'; li.textContent = name;
                // clear active from others
                Array.from(recentList.children).forEach(function(n){ n.classList.remove('active'); });
                recentList.insertBefore(li, recentList.firstChild);
                while(recentList.children.length>5) recentList.removeChild(recentList.lastChild);
            }

            // show/hide picker
            function showPicker(targetType, anchorEl){
                if(!routePicker) return;
                routePicker.style.display = 'block';
                routePicker.setAttribute('data-target', targetType);
                routePicker.style.opacity = 0; routePicker.style.transition = 'opacity 180ms ease';
                requestAnimationFrame(function(){ routePicker.style.opacity = 1; });
                // position under the anchor
                if(anchorEl){
                    var rect = anchorEl.getBoundingClientRect();
                    routePicker.style.position = 'absolute';
                    routePicker.style.left = (rect.left) + 'px';
                    routePicker.style.top = (rect.bottom + 6) + 'px';
                    routePicker.style.zIndex = 13001;
                }
            }
            function hidePicker(){ if(!routePicker) return; routePicker.style.display = 'none'; routePicker.removeAttribute('data-target'); }

            // wire clicking the start/dest fields to open picker
            document.addEventListener('click', function(ev){
                var field = ev.target.closest('.route-field');
                if(field){
                    ev.preventDefault();
                    var type = field.getAttribute('data-type');
                    showPicker(type, field);
                    return;
                }
                // click outside -> hide
                if(!ev.target.closest('.route-picker')) hidePicker();
            });

            // select option from picker
            if(routeOptions){
                routeOptions.forEach(function(op){
                    op.addEventListener('click', function(){
                        var target = routePicker ? routePicker.getAttribute('data-target') : null;
                        var name = op.textContent.trim();
                        if(target==='start' && startInput){ startInput.value = name; }
                        if(target==='dest' && destInput){ destInput.value = name; }
                        hidePicker();
                        var combined = setCurrentRouteCombined();
                        if(combined && combined!=='—') pushRecentRoute(combined);
                        updateTripToggleState();
                    });
                });
            }

            // recent list click: set both inputs if possible (expects 'Start - Dest')
            if(recentList){
                recentList.addEventListener('click', function(e){
                    var li = e.target.closest('.recent-item'); if(!li) return;
                    var text = li.textContent.trim();
                    var parts = text.split(' - ');
                    if(parts.length>=2){ if(startInput) startInput.value = parts[0]; if(destInput) destInput.value = parts.slice(1).join(' - '); }
                    // mark active
                    Array.from(recentList.children).forEach(function(n){ n.classList.remove('active'); });
                    li.classList.add('active');
                    setCurrentRouteCombined(); updateTripToggleState();
                });
            }

            // trip toggle
            var tripActive = false;
            if(tripToggle){
                // initialize disabled state
                updateTripToggleState();
                tripToggle.addEventListener('click', function(){
                    if(tripToggle.disabled) return;
                    tripActive = !tripActive;
                    if(tripActive){
                        tripToggle.textContent = 'End Trip';
                        tripToggle.classList.remove('start-trip-button');
                        tripToggle.classList.add('end-trip-button');
                        if(vehicleStatus) vehicleStatus.textContent = 'On Trip';
                    } else {
                        tripToggle.textContent = 'Start Trip';
                        tripToggle.classList.remove('end-trip-button');
                        tripToggle.classList.add('start-trip-button');
                        if(vehicleStatus) vehicleStatus.textContent = 'Standby';
                    }
                });
            }

            // expose helper for other code if needed
            window.setDriverRoute = function(start, dest){ if(startInput) startInput.value=start; if(destInput) destInput.value=dest; setCurrentRouteCombined(); pushRecentRoute(setCurrentRouteCombined()); updateTripToggleState(); };

            // init: populate current route if recent active exists
            (function init(){
                var firstActive = document.querySelector('.recent-item.active');
                if(firstActive){
                    var txt = firstActive.textContent.trim();
                    var parts = txt.split(' - ');
                    if(parts.length>=2){ if(startInput) startInput.value=parts[0]; if(destInput) destInput.value=parts.slice(1).join(' - '); }
                    setCurrentRouteCombined();
                }
                updateTripToggleState();
            })();
        })();
    </script>
</body>
</html>
